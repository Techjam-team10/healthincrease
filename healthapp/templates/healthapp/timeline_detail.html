{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'healthapp/css/style.css' %}">
<link rel="stylesheet" href="{% static 'healthapp/css/timeline.css' %}">
<script src="{% static 'healthapp/js/timeline.js' %}" defer></script>

<section class="timeline timeline--detail">
    <header class="timeline__header">
        <h2 class="timeline__title">投稿詳細</h2>
        <a class="timeline__link" href="{% url 'healthapp:timeline' %}">タイムラインへ戻る</a>
    </header>

    {% if notice %}
        <p class="timeline__notice">{{ notice }}</p>
    {% endif %}

    {% if post %}
        <article class="timeline__card timeline__card--detail">
            <div class="timeline__card-header">
                <p class="timeline__author">{{ post.user.mail }}</p>
                <time class="timeline__date">{{ post.created_at|date:"Y/m/d H:i" }}</time>
            </div>
            <p class="timeline__content">{{ post.content }}</p>
            <form method="post" class="timeline__action">
                {% csrf_token %}
                <input type="hidden" name="action" value="favorite">
                <button
                    type="submit"
                    class="timeline__button timeline__button--ghost"
                    {% if post.id in liked_post_ids %}disabled{% endif %}
                >
                    {% if post.id in liked_post_ids %}
                        いいね済み {{ post.favorite }}
                    {% else %}
                        いいね {{ post.favorite }}
                    {% endif %}
                </button>
            </form>
        </article>

        <div class="timeline__comments">
            <h3 class="timeline__section-title">コメント</h3>
            <form class="timeline__form" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="comment">
                <label class="timeline__label" for="comment-content">コメントする</label>
                <textarea id="comment-content" name="content" rows="3" maxlength="200" class="timeline__textarea" placeholder="コメントを書いてください"></textarea>
                <div class="timeline__form-footer">
                    <span class="timeline__counter" data-counter="comment-content">0 / 200</span>
                    <button type="submit" class="timeline__button" {% if not has_user %}disabled{% endif %}>送信</button>
                </div>
                {% if not has_user %}
                    <p class="timeline__hint">コメントするにはユーザーが必要です。</p>
                {% endif %}
            </form>

            {% if comments %}
                <ul class="timeline__comment-list">
                    {% for comment in comments %}
                        <li class="timeline__comment">
                            <div class="timeline__comment-header">
                                <span class="timeline__author">{{ comment.user.mail }}</span>
                                <time class="timeline__date">{{ comment.created_at|date:"Y/m/d H:i" }}</time>
                            </div>
                            <p class="timeline__comment-content">{{ comment.content }}</p>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="timeline__empty">まだコメントがありません。</p>
            {% endif %}
        </div>
    {% else %}
        <p class="timeline__empty">投稿が見つかりませんでした。</p>
    {% endif %}
</section>
{% endblock %}