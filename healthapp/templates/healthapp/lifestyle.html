{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'healthapp/css/style.css' %}">
<link rel="stylesheet" href="{% static 'healthapp/css/lifestyle.css' %}">
<h2>行動の作成</h2>

{% if notice %}
	<p>{{ notice }}</p>
{% endif %}

<form method="post" action="{% url 'healthapp:lifestyle' %}">
	{% csrf_token %}
	<div>
		<label for="id_date">日付</label>
		<input type="date" name="date" id="id_date" value="{{ date_value|date:'Y-m-d' }}">
	</div>
	<div>
		<label for="id_self_evaluation">自己評価(0〜100)</label>
		<input
			type="number"
			name="self_evaluation"
			id="id_self_evaluation"
			min="0"
			max="100"
			value="{{ self_evaluation_value }}"
		>
	</div>

	<div id="action-rows">
		{% for row in rows %}
		<div class="action-row">
			<div>
				<label>カテゴリ</label>
				<select name="category">
					<option value="">--選択--</option>
					{% for group in category_groups %}
					<optgroup label="{{ group.parent }}">
						{% for child in group.children %}
						<option value="{{ child.value }}" {% if row.category_value == child.value %}selected{% endif %}>
							{{ child.title }}
						</option>
						{% endfor %}
					</optgroup>
					{% endfor %}
				</select>
			</div>
			<div>
				<label>時間(時間)</label>
				<input type="number" name="time" min="0" step="0.1" value="{{ row.time }}">
			</div>
			<div>
				<label>内容(任意)</label>
				<input type="text" name="content" value="{{ row.content }}">
			</div>
			<div>
				<button type="button" class="remove-row">-</button>
			</div>
		</div>
		{% endfor %}
	</div>
	<button type="button" id="add-row">＋</button>
	<button type="submit">追加</button>
</form>

<hr>

<h2>今までの行動</h2>

{% if grouped_items %}
	{% for group_date, group in grouped_items %}
		<section class="lifestyle-group">
			<h3>
				{{ group_date }}
				<span>（自己評価: {{ group.0.self_evaluation }}%）</span>
			</h3>
			<table border="1">
				<thead>
					<tr>
						<th class="column1">カテゴリ</th>
						<th class="column2">時間</th>
						<th class="column3">内容</th>
						<th class="column4">操作</th>
					</tr>
				</thead>
				<tbody>
					{% for item in group %}
					<tr>
						<td>{{ item.category }}</td>
						<td>{{ item.time }}時間</td>
						<td>{{ item.content|default:"-" }}</td>
						<td>
							<a href="{% url 'healthapp:lifestyle_detail' group_date|date:'Y-m-d' %}">詳細・編集</a>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</section>
	{% endfor %}
{% else %}
	<p>行動がありません。</p>
{% endif %}

<template id="action-row-template">
	<div class="action-row">
		<div>
			<label>カテゴリ</label>
			<select name="category">
				<option value="">--選択--</option>
				{% for group in category_groups %}
				<optgroup label="{{ group.parent }}">
					{% for child in group.children %}
					<option value="{{ child.value }}">{{ child.title }}</option>
					{% endfor %}
				</optgroup>
				{% endfor %}
			</select>
		</div>
		<div>
			<label>時間(時間)</label>
			<input type="number" name="time" min="0" step="0.1" value="">
		</div>
		<div>
			<label>内容(任意)</label>
			<input type="text" name="content" value="">
		</div>
		<div>
			<button type="button" class="remove-row">-</button>
		</div>
	</div>
</template>

<script>
	const actionRows = document.getElementById('action-rows');
	const addRowButton = document.getElementById('add-row');
	const rowTemplate = document.getElementById('action-row-template');

	const updateRemoveButtons = () => {
		const buttons = actionRows.querySelectorAll('.remove-row');
		buttons.forEach((button) => {
			button.disabled = buttons.length <= 1;
		});
	};

	addRowButton.addEventListener('click', () => {
		actionRows.appendChild(rowTemplate.content.cloneNode(true));
		updateRemoveButtons();
	});

	actionRows.addEventListener('click', (event) => {
		if (event.target.classList.contains('remove-row')) {
			const row = event.target.closest('.action-row');
			if (row && actionRows.children.length > 1) {
				row.remove();
				updateRemoveButtons();
			}
		}
	});

	updateRemoveButtons();
</script>
{% endblock %}